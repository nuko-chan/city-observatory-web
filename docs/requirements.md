# City Observatory - 要件定義書

## 1. プロジェクト概要

### 1.1 プロジェクト名

**City Observatory（シティ・オブザバトリー）**

### 1.2 コンセプト

都市の"いま"を観測するダッシュボード - 日本地図上で天気・大気質・体感指数などをリアルタイムに可視化し、複数都市の比較も可能にする Web アプリケーション

### 1.2.1 対象地域と前提（日本・東京）

- **対象地域**: 日本（初期は東京を基準）
- **言語/単位**: 日本語/UI、メートル法（℃、m/s、mm）
- **タイムゾーン**: `Asia/Tokyo`
- **既定都市**: Tokyo

---

## 1.3 MVP スコープ（肥大化防止）

### MVP（必須）

- 都市検索（日本語/英語）
- 天気の現在値 + 24h/7d の基本表示
- 大気質の現在値 + 24h/5d の基本表示
- 地図表示（マーカー・ズーム・クレジット表記）
- レスポンシブ（PC/SP）

### MVP 後（段階導入）

- 比較モード（F5）
- 派生指標（F6）
- 地図レイヤー（降水/ヒートマップ）
- 高度なアニメーションや PWA

### 1.3 目的・背景

#### ビジネス目的

- **転職活動用ポートフォリオの作成**
- フロントエンド開発スキルの証明
- エージェント・人事担当者に「30 秒で刺さる」成果物の提供

#### 技術的目的

- モダンなフロントエンド技術スタックの実践
- データ可視化・状態管理・UX 設計の能力証明
- プロダクトレベルの品質管理の実証

#### 制約条件

- **フロントエンドのみで完結**（バックエンド不要）
- **完全非商用**（ポートフォリオ用途）
- **無料デプロイ**（Vercel 無料枠）
- **無料 API**（Open-Meteo 等のキー不要 API を優先使用）

---

## 2. ターゲットユーザー

### 2.1 主要ペルソナ

1. **採用担当者・人事**
   - ポートフォリオを 30 秒〜1 分で評価
   - 見た目の完成度と技術力のバランスを重視

2. **フリーランスエージェント**
   - 案件マッチング時の実績確認
   - すぐに動くデモが見られることを期待

3. **技術面接官**
   - コード品質・設計思想を確認
   - パフォーマンス・エラーハンドリングを評価

---

## 3. 主要機能要件

### 3.1 コア機能（必須）

#### F1. 都市検索機能

- [ ] **F1-1**: テキスト入力による都市名検索（日本語・英語対応）
- [ ] **F1-2**: インクリメンタルサーチ（入力中のサジェスト表示）
- [ ] **F1-3**: キーボード操作対応（↑↓ でサジェスト選択、Enter で決定）
- [ ] **F1-4**: おすすめ都市のクイックアクセス（Tokyo, Osaka, Sapporo 等）
- [ ] **F1-5**: 検索結果の位置情報取得（緯度・経度・タイムゾーン）

#### F2. 地図表示機能

- [ ] **F2-1**: インタラクティブな地図表示（ズーム・パン対応）
- [ ] **F2-2**: 都市マーカーの表示と中心座標への移動
- [ ] **F2-3**: 地図スタイル切替（ライト/ダーク/昼/夜）
- [ ] **F2-4**: レイヤー切替（天気/大気質/降水量）
- [ ] **F2-5**: クレジット表記（OSM + MapTiler、Free プランならロゴも）
- [ ] **F2-6**: レスポンシブ対応（PC: 右半分、SP: 縮小 or 折りたたみ）

#### F3. 天気データ表示機能

- [ ] **F3-1**: 現在の気象データ表示（気温/湿度/風速/降水確率）
- [ ] **F3-2**: 24 時間予報の時系列チャート
- [ ] **F3-3**: 7 日間予報の時系列チャート
- [ ] **F3-4**: 体感温度の算出と表示
- [ ] **F3-5**: 降水確率の視覚的表現（アイコン・カラーコード）

#### F4. 大気質（AQ）データ表示機能

- [ ] **F4-1**: PM2.5 濃度の表示
- [ ] **F4-2**: PM10 濃度の表示
- [ ] **F4-3**: その他大気汚染物質の表示（NO2, O3 等）
- [ ] **F4-4**: AQ 指数の可視化（カラーコード・グラデーション）
- [ ] **F4-5**: 24 時間/5 日間の AQ 予報チャート

#### F5. 都市比較機能

- [ ] **F5-1**: 2 都市の主要指標を横並び比較
- [ ] **F5-2**: 比較対象都市の選択 UI（ドロップダウン or 検索）
- [ ] **F5-3**: 比較チャートの表示（気温/AQ/降水量等）
- [ ] **F5-4**: URL 共有機能（比較状態をクエリパラメータで保持）
- [ ] **F5-5**: 比較結果のハイライト表示（差分の強調）

**注記**: 比較機能は MVP 完了後に実装する（複雑化防止）

### 3.2 派生機能（推奨）

#### F6. 派生指標の算出・表示

- [ ] **F6-1**: 快適度スコアの算出（気温・湿度・風・降水・AQ から算出）
- [ ] **F6-2**: 外出リスクレベルの算出（雨 × 風 ×AQ）
- [ ] **F6-3**: ベストタイムスロットの提案（24 時間内で最も快適な時間帯）
- [ ] **F6-4**: 算出ロジックの透明性確保（計算式の説明を UI 内に表示）

**注記**: 派生指標は MVP 完了後に段階導入する（計算式の妥当性検証が必要）

#### F7. UX 強化機能

- [ ] **F7-1**: スケルトンローディング（データ取得中）
- [ ] **F7-2**: スムーズなトランジション（タブ切替・カード展開）
- [ ] **F7-3**: エラー時のフォールバック表示（再試行ボタン付き）
- [ ] **F7-4**: キャッシュ機能（5〜15 分 stale、手動 refresh）
- [ ] **F7-5**: パフォーマンス最適化（遅延ロード・メモ化）

### 3.3 管理・運用機能（任意）

#### F8. 状態管理・URL 同期

- [ ] **F8-1**: URL クエリパラメータでの状態保持（`?city=tokyo&tab=aq&range=5d`）
- [ ] **F8-2**: ブラウザバック/フォワード対応
- [ ] **F8-3**: URL 共有による状態再現

#### F9. 監視・分析（任意）

- [ ] **F9-1**: エラー監視（Sentry 等の導入）
- [ ] **F9-2**: アクセス解析（Vercel Analytics / GA 等）
- [ ] **F9-3**: パフォーマンス監視（Core Web Vitals）

---

## 4. 非機能要件

### 4.1 パフォーマンス要件（目安）

- [ ] **NFR-P1**: First Contentful Paint (FCP) < 1.5 秒
- [ ] **NFR-P2**: Largest Contentful Paint (LCP) < 2.5 秒
- [ ] **NFR-P3**: Cumulative Layout Shift (CLS) < 0.1
- [ ] **NFR-P4**: Time to Interactive (TTI) < 3 秒
- [ ] **NFR-P5**: Lighthouse スコア 90 点以上（Performance）

### 4.2 互換性要件

- [ ] **NFR-C1**: モダンブラウザ対応（Chrome/Firefox/Safari/Edge 最新版）
- [ ] **NFR-C2**: レスポンシブデザイン（SP/Tablet/PC）
- [ ] **NFR-C3**: ダークモード対応
- [ ] **NFR-C4**: タイムゾーン対応（都市ごとの現地時刻表示）

### 4.3 アクセシビリティ要件

- [ ] **NFR-A1**: WAI-ARIA 準拠（主要なランドマーク・ラベル）
- [ ] **NFR-A2**: キーボード操作対応（Tab/Enter/Escape）
- [ ] **NFR-A3**: スクリーンリーダー対応（aria-label 等）
- [ ] **NFR-A4**: カラーコントラスト比 4.5:1 以上（WCAG AA 準拠）
- [ ] **NFR-A5**: フォーカスインジケーター表示

### 4.4 セキュリティ要件

- [ ] **NFR-S1**: API キーの安全な管理（環境変数、ドメイン制限）
- [ ] **NFR-S2**: XSS 対策（ユーザー入力のサニタイズ）
- [ ] **NFR-S3**: HTTPS 通信の強制
- [ ] **NFR-S4**: 依存パッケージの脆弱性チェック（npm audit / Snyk）

### 4.5 運用要件

- [ ] **NFR-O1**: エラーログの記録（クライアントサイド）
- [ ] **NFR-O2**: API レート制限の遵守（429 エラー時の適切な処理）
- [ ] **NFR-O3**: キャッシュ戦略の実装（過剰な API 呼び出し防止）
- [ ] **NFR-O4**: フォールバック表示（API 障害時の代替 UI）

### 4.6 品質要件

- [ ] **NFR-Q1**: TypeScript 厳格モード（strict: true）
- [ ] **NFR-Q2**: ESLint/Prettier によるコード品質管理
- [ ] **NFR-Q3**: ユニットテスト（派生指標・ドメイン関数の最小限）
- [ ] **NFR-Q4**: E2E テスト（最低 1 本: 都市検索 → ダッシュボード表示）
- [ ] **NFR-Q5**: Zod による実行時型バリデーション
- [ ] **NFR-Q6**: 責務分離と単一責任（UI/Model/Domain を明確に分割）
- [ ] **NFR-Q7**: useRef/useEffect は原則使用しない（不可避な場合のみ最小範囲で使用）
- [ ] **NFR-Q8**: any は原則禁止（不可避時は局所化し理由を明記）

---

## 5. 画面構成

### 5.1 画面一覧

#### 画面 A: Landing（ランディングページ）

**目的**: 都市選択とアプリの第一印象形成

**主要要素**:

- ヘッダー（アプリ名・ロゴ）
- 検索ボックス（都市名入力・サジェスト）
- おすすめ都市カード（3〜6 都市）
- デモ動画/アニメーション（任意）
- フッター（クレジット・GitHub リンク）

**遷移先**: 都市選択後 → City Dashboard

---

#### 画面 B: City Dashboard（メインダッシュボード）

**目的**: 選択都市の詳細データ表示・分析

**レイアウト**（PC: 2 カラム、SP: 縦積み）:

**左カラム（情報パネル）**:

- 都市情報ヘッダー（都市名・国・現地時刻）
- KPI カード（現在値: 気温/体感温度/降水確率/PM2.5 等）
- タブ切替（天気/大気質/詳細）
- 時系列チャート（24h/7d 切替、AQ は 5d）
- 詳細テーブル（時間帯ごとの数値）

**右カラム（地図）**:

- インタラクティブ地図（MapLibre）
- レイヤー切替ボタン（天気/AQ/降水）
- スタイル切替ボタン（ライト/ダーク）
- クレジット表記（OSM + MapTiler）

**遷移先**:

- 比較モード切替 → Compare Mode
- 都市変更 → Landing or 検索モーダル

---

#### 画面 C: Compare Mode（都市比較モード）

**目的**: 複数都市の主要指標を横並び比較

**レイアウト**:

- 都市選択 UI（2 都市分のドロップダウン/検索）
- 比較カード（気温/体感温度/降水確率/PM2.5 等を横並び）
- 比較チャート（時系列グラフを重ねて表示）
- 差分ハイライト（数値の大小をカラーコード）
- URL 共有ボタン（クエリパラメータでの状態保持）

**遷移先**:

- 通常モード切替 → City Dashboard

---

## 6. データモデル

### 6.1 Location（都市情報）

```typescript
type Location = {
  id: number; // 一意識別子（Open-MeteoのGeoNames ID）
  name: string; // 都市名（例: "Tokyo"）
  country: string; // 国名（例: "Japan"）
  lat: number; // 緯度
  lon: number; // 経度
  timezone: string; // タイムゾーン（例: "Asia/Tokyo"）
  elevation?: number; // 標高（メートル）
};
```

### 6.2 WeatherHourly（時間ごとの天気）

```typescript
type WeatherHourly = {
  time: string[]; // ISO8601形式のタイムスタンプ配列
  temperature_2m: number[]; // 気温（℃）
  relative_humidity_2m: number[]; // 湿度（%）
  precipitation_probability: number[]; // 降水確率（%）
  wind_speed_10m: number[]; // 風速（m/s）
  apparent_temperature: number[]; // 体感温度（℃）
};
```

### 6.3 WeatherDaily（日ごとの天気）

```typescript
type WeatherDaily = {
  time: string[]; // 日付配列（YYYY-MM-DD）
  temperature_2m_max: number[]; // 最高気温（℃）
  temperature_2m_min: number[]; // 最低気温（℃）
  precipitation_sum: number[]; // 降水量合計（mm）
  precipitation_probability_max: number[]; // 最大降水確率（%）
};
```

### 6.4 AirQualityHourly（時間ごとの大気質）

```typescript
type AirQualityHourly = {
  time: string[]; // ISO8601形式のタイムスタンプ配列
  pm10: number[]; // PM10濃度（μg/m³）
  pm2_5: number[]; // PM2.5濃度（μg/m³）
  nitrogen_dioxide: number[]; // NO2濃度（μg/m³）
  ozone: number[]; // O3濃度（μg/m³）
};
```

### 6.5 DerivedMetrics（派生指標）

```typescript
type DerivedMetrics = {
  comfortScore: number; // 快適度スコア（0-100）
  outdoorRiskLevel: "low" | "medium" | "high"; // 外出リスク
  bestTimeSlots: TimeSlot[]; // おすすめ時間帯
  aqiLevel: "good" | "moderate" | "unhealthy" | "hazardous"; // 空気の状態ラベル（簡易）
};

type TimeSlot = {
  startTime: string; // 開始時刻（ISO8601）
  endTime: string; // 終了時刻（ISO8601）
  score: number; // 快適度スコア
};
```

**日本・東京向けの初期チューニング案（推測）**

- 快適度は「不快指数」等の簡易式をベースにし、東京の季節感に合わせて重みを調整する
- AQI という厳密指標は使わず、**PM2.5 を元にした簡易ラベル**で運用する
- 表示は「良い/注意/悪い/危険」など直感的な日本語ラベルを優先する

※上記は推測。正式な式・分類は実装時に確認し、必要に応じて変更する。

---

## 7. API 仕様（外部 API）

### 7.1 Open-Meteo Geocoding API

- **エンドポイント**: `https://geocoding-api.open-meteo.com/v1/search`
- **用途**: 都市名から位置情報を取得
- **認証**: 不要（非商用利用）
- **レート制限**: 明記なし（過剰利用は禁止）

### 7.2 Open-Meteo Weather Forecast API

- **エンドポイント**: `https://api.open-meteo.com/v1/forecast`
- **用途**: 天気予報データの取得
- **認証**: 不要（非商用利用）
- **レート制限**: 明記なし（商用は有料プランが必要）

### 7.3 Open-Meteo Air Quality API

- **エンドポイント**: `https://air-quality-api.open-meteo.com/v1/air-quality`
- **用途**: 大気質予報データの取得
- **認証**: 不要（非商用利用）
- **レート制限**: 明記なし（過剰利用は禁止）

### 7.4 MapTiler Vector Tiles

- **用途**: 地図タイルの取得
- **認証**: API キー必要（NEXT_PUBLIC_MAPTILER_KEY）
- **レート制限**: Free プラン - 100,000 タイル/月
- **保護**: Allowed HTTP origins 設定必須

### 7.5 OpenWeatherMap Precipitation Tiles

- **用途**: 降水レイヤーの取得
- **認証**: API キー必要（NEXT_PUBLIC_OPENWEATHER_KEY）
- **レート制限**: プランに依存（開発用途は無料枠想定）

---

## 8. 成功指標（KPI）

### 8.1 ポートフォリオとしての評価指標

- [ ] **KPI-1**: 面談時のポジティブフィードバック獲得
- [ ] **KPI-2**: GitHub スター数 10 以上
- [ ] **KPI-3**: デモサイトの平均滞在時間 > 1 分
- [ ] **KPI-4**: レジュメ提出時の差別化要素として機能

### 8.2 技術的品質指標

- [ ] **KPI-5**: Lighthouse Performance スコア 90+
- [ ] **KPI-6**: Zero 致命的バグ（本番環境）
- [ ] **KPI-7**: テストカバレッジ > 70%（派生ロジック部分）
- [ ] **KPI-8**: バンドルサイズ < 300KB（gzip 圧縮後）

---

## 9. スコープ外（今回は実装しない）

### 9.1 認証・ユーザー管理

- ログイン機能
- ユーザー登録
- お気に入り都市の保存（ローカルストレージは可）

### 9.2 バックエンド

- サーバーサイドロジック
- データベース
- 独自 API 構築

### 9.3 高度な機能

- リアルタイム通知
- プッシュ通知
- 多言語対応（日本語・英語のみ）
- オフライン対応（PWA 化は任意）

---

## 10. 制約事項・前提条件

### 10.1 技術的制約

- Next.js App Router 必須（Pages Router は使用不可）
- TypeScript 必須（JavaScript は使用不可）
- pnpm 必須（npm/yarn は使用不可）
- React Server Components 優先（Client Components は必要最小限）

### 10.2 コスト制約

- 全ての API は無料枠内で利用
- MapTiler は無料プラン（100,000 タイル/月）
- Vercel は無料プラン（100GB 帯域/月）
- 追加の有料サービスは原則使用しない

### 10.3 ライセンス・規約遵守

- Open-Meteo: 非商用利用（商用は有料プラン必須）
- MapTiler: クレジット表記必須、Free プランはロゴ表示必須
- OpenStreetMap: クレジット表記必須、リンク付き
- タイルの大量ダウンロード・プリフェッチ禁止

---

## 11. リスクと対策

### 11.1 技術リスク

| リスク                     | 影響度 | 対策                                                   |
| -------------------------- | ------ | ------------------------------------------------------ |
| API レート制限超過         | 高     | キャッシュ実装、更新間隔固定、429 エラー時の適切な処理 |
| MapTiler キーの盗用        | 中     | Allowed HTTP origins 設定、使用量アラート              |
| SSR/ハイドレーションエラー | 中     | dynamic import（ssr:false）、Client Component 分離     |
| パフォーマンス劣化         | 中     | 遅延ロード、メモ化、バンドルサイズ最適化               |

### 11.2 運用リスク

| リスク                 | 影響度 | 対策                                 |
| ---------------------- | ------ | ------------------------------------ |
| API 障害・ダウンタイム | 中     | フォールバック表示、エラーバウンダリ |
| データ精度の問題       | 低     | データソース明記、免責事項表示       |
| ブラウザ互換性問題     | 低     | 主要ブラウザでの E2E テスト          |

---

## 12. スケジュール（目安）

### フェーズ 1: セットアップ（1 日）

- 環境構築、API キー取得、リポジトリ初期化

### フェーズ 2: コア実装（2-3 日）

- データ層実装、画面実装、状態管理

### フェーズ 3: 地図実装（1-2 日）

- MapLibre 統合、レイヤー実装、クレジット表記

### フェーズ 4: 品質向上（1 日）

- テスト、パフォーマンス最適化、アクセシビリティ

### フェーズ 5: デプロイ・仕上げ（0.5 日）

- Vercel デプロイ、README 作成、スクリーンショット

**合計: 5.5-7.5 日（AI 駆動で実装した場合の想定）**

---

## 13. 参考資料

### 13.1 技術ドキュメント

- [Next.js App Router Docs](https://nextjs.org/docs)
- [shadcn/ui Documentation](https://ui.shadcn.com/)
- [Open-Meteo API Documentation](https://open-meteo.com/en/docs)
- [MapTiler Docs](https://docs.maptiler.com/)
- [MapLibre GL JS Docs](https://maplibre.org/)

### 13.2 ライセンス・規約

- [Open-Meteo Terms](https://open-meteo.com/en/terms)
- [MapTiler Terms of Service](https://www.maptiler.com/terms/)
- [OpenStreetMap Copyright](https://www.openstreetmap.org/copyright)
- [OSMF Tile Usage Policy](https://operations.osmfoundation.org/policies/tiles/)

---

**最終更新**: 2026-01-31
**作成者**: haru
**バージョン**: 1.0
